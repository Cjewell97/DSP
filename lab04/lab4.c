#include "stm32l4xx_hal.h"
#include "stm32l476g_discovery.h"
#include "ece486.h"
#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include "ece486_nco.h"
#include <stdint.h>
#include "arm_math.h"
#include "arm_const_structs.h"
#include <stdint.h>

// To detect a button press
extern FlagStatus KeyPressed;

#define DISPLAY_CLEAR	(uint8_t) "        "
#define SAMPLING_FREQUENCY	32000.00000
#define ONE_KHZ	1000.0

int main(void){

	int nsamp; // Size of input and output blocks
	float *input, *output; // Arrays for input and output blocks
	int counter = 0; // Track number of input blocks
	int button_count = 0; // Track number of button presses
	int F_0 = 0; // Center frequency for the mixer
	uint16_t numTaps = 68; // Number of coefficients for FIR filter
	uint8_t M = 10; // Decimation factor
	uint32_t blockSize; // Size of input and output blocks
	int fftSize = 1024; // Set size for ARM FFT
	float *real, *cmplx, *fft_real, *fft_cmplx, *fft_array;
	float ramp[1280];
	float temp;
	int decimate_size = 1280/M;

	// String to hold F_0
	char dispString[8];
	


	// Set the blocksize to 1280, will make the fftsize equal to 1024
	setblocksize(1280);

	// Initialize the board

	// Keep track of blocksize
	nsamp = getblocksize(); 
	blockSize = nsamp;
	initialize_ece486(FS_32K, MONO_IN, STEREO_OUT, HSE_EXTERNAL_8MHz);

	// Memory Allocation
	input = (float *)calloc(blockSize, sizeof(float));
	real = (float *)calloc(blockSize, sizeof(float));
	cmplx = (float *)calloc(blockSize, sizeof(float));
	fft_real = (float *)calloc(fftSize, sizeof(float));
	fft_cmplx = (float *)calloc(fftSize, sizeof(float));
	fft_array = (float *)calloc(fftSize*2, sizeof(float));

	// Create ARM FIR filter instances
	arm_fir_decimate_instance_f32 *s1 = (arm_fir_decimate_instance_f32 *)malloc(sizeof(arm_fir_decimate_instance_f32));
	arm_fir_decimate_instance_f32 *s2 = (arm_fir_decimate_instance_f32 *)malloc(sizeof(arm_fir_decimate_instance_f32));
	
	float *win_in = (float *)calloc(fftSize*2, sizeof(float));

	output = (float *)calloc(blockSize, sizeof(float));

	// Keep track of decimated samples
	float *decBlock = (float *)calloc(blockSize/M, sizeof(float));

	// Keep track of FIR filter states between blocks
	float32_t *pState = (float32_t *)malloc((numTaps+blockSize-1)*sizeof(float32_t));
	float32_t *pState2 = (float32_t *)malloc((numTaps+blockSize-1)*sizeof(float32_t));

	// Check for memory allocation errors
	if (input==NULL||output==NULL||fft_real==NULL||fft_cmplx==NULL||cmplx==NULL||real==NULL) {
		flagerror(MEMORY_ALLOCATION_ERROR);
		while(1);
	}

	// Set up NCO waveforms

	// Change the power to prevent the DAC from blowing up

	// Coefficients for FIR lowpass decimation filter found from MATLAB (FilterDesigner.m)
	static float pCoeffs[68] = {
		-0.000196958579200974895091064142960135541,
		0.000859272050356308433188834428051450232,
		0.001134552734713145400596845391305578232,
		0.001699237856734259199953385177650488913,
		0.002372978856351966748389203942792846647,
		0.0030661922227558724776685927793096198  ,
		0.003686205203789461558316897793474709033,
		0.004124633099526988158634033254656969802,
		0.004265876592450362249364648192795357318,
		0.003998555345094188459564854554173507495,
		0.003231466554200309020811188176480754919,
		0.001910217012675314435243834054745093454,
		0.000032786164465227604289387919322962262,
		-0.002337135187243520768884952332200555247,
		-0.005062655502679251628972423304730909877,
		-0.007932763752316385197360659731202758849,
		-0.010669436472747498290125633957359241322,
		-0.012942984873164087300523306112154386938,
		-0.014395019943036248266654553162879892625,
		-0.014667957349316539800154757244854408782,
		-0.013438641602154667575863555839532637037,
		-0.010452954981632834458027403456981119234,
		-0.00555761860895989841246933593765788828 ,
		0.001273869895185063402451297598361179553,
		0.009924714577150151734175054230036039371,
		0.020129388351999517869916900281168636866,
		0.031481127923038428051416559583230991848,
		0.043453339202320959144820733399683376774,
		0.055432088874347598683733906455017859116,
		0.066759492909291090478873798019776586443,
		0.076781469011989830764086661929468391463,
		0.084896600900275273615669391347182681784,
		0.090607565952797175512500871263910084963,
		0.093555370936809600923567131758318282664,
		0.093555370936809600923567131758318282664,
		0.090607565952797175512500871263910084963,
		0.084896600900275273615669391347182681784,
		0.076781469011989830764086661929468391463,
		0.066759492909291090478873798019776586443,
		0.055432088874347598683733906455017859116,
		0.043453339202320959144820733399683376774,
		0.031481127923038428051416559583230991848,
		0.020129388351999517869916900281168636866,
		0.009924714577150151734175054230036039371,
		0.001273869895185063402451297598361179553,
		-0.00555761860895989841246933593765788828 ,
		-0.010452954981632834458027403456981119234,
		-0.013438641602154667575863555839532637037,
		-0.014667957349316539800154757244854408782,
		-0.014395019943036248266654553162879892625,
		-0.012942984873164087300523306112154386938,
		-0.010669436472747498290125633957359241322,
		-0.007932763752316385197360659731202758849,
		-0.005062655502679251628972423304730909877,
		-0.002337135187243520768884952332200555247,
		0.000032786164465227604289387919322962262,
		0.001910217012675314435243834054745093454,
		0.003231466554200309020811188176480754919,
		0.003998555345094188459564854554173507495,
		0.004265876592450362249364648192795357318,
		0.004124633099526988158634033254656969802,
		0.003686205203789461558316897793474709033,
		0.0030661922227558724776685927793096198  ,
		0.002372978856351966748389203942792846647,
		0.001699237856734259199953385177650488913,
		0.001134552734713145400596845391305578232,
		0.000859272050356308433188834428051450232,
		-0.000196958579200974895091064142960135541
	};

	// Initialization for CMSIS DSP ARM FIR Decimation filter	
	arm_fir_decimate_init_f32(s1, numTaps, M, pCoeffs, pState, blockSize);
	arm_fir_decimate_init_f32(s2, numTaps, M, pCoeffs, pState2, blockSize);

	// Allocate FFT array

	// Check for allocation errors
	if (fft_array == NULL|| win_in == NULL || pState == NULL || pState2 == NULL || decBlock == NULL) {
		flagerror(MEMORY_ALLOCATION_ERROR);
		while(1);
	} 

	// List of window coefficients generated by Matlab Kaiser.m script
	float win[1024] = {
		0.000914421, 0.000988196, 0.00106476, 0.00114416, 0.00122647, 
		0.00131174, 0.00140004, 0.00149143, 0.00158597, 0.00168373, 
		0.00178476, 0.00188915, 0.00199694, 0.00210821, 0.00222303, 
		0.00234145, 0.00246356, 0.00258941, 0.00271908, 0.00285263, 
		0.00299014, 0.00313168, 0.00327732, 0.00342713, 0.00358118, 
		0.00373955, 0.00390232, 0.00406954, 0.00424131, 0.0044177, 
		0.00459878, 0.00478463, 0.00497532, 0.00517094, 0.00537156, 
		0.00557726, 0.00578813, 0.00600423, 0.00622565, 0.00645248, 
		0.00668479, 0.00692266, 0.00716619, 0.00741544, 0.0076705, 
		0.00793146, 0.0081984, 0.00847141, 0.00875057, 0.00903597, 
		0.00932768, 0.00962581, 0.00993043, 0.0102416, 0.0105595, 
		0.0108841, 0.0112156, 0.011554, 0.0118995, 0.012252, 
		0.0126117, 0.0129788, 0.0133532, 0.0137351, 0.0141245, 
		0.0145217, 0.0149265, 0.0153392, 0.0157598, 0.0161885, 
		0.0166252, 0.0170702, 0.0175234, 0.0179851, 0.0184552, 
		0.0189339, 0.0194213, 0.0199175, 0.0204225, 0.0209364, 
		0.0214595, 0.0219916, 0.022533, 0.0230837, 0.0236438, 
		0.0242135, 0.0247927, 0.0253817, 0.0259804, 0.0265891, 
		0.0272077, 0.0278364, 0.0284753, 0.0291245, 0.029784, 
		0.030454, 0.0311345, 0.0318257, 0.0325276, 0.0332404, 
		0.033964, 0.0346987, 0.0354445, 0.0362015, 0.0369698, 
		0.0377495, 0.0385407, 0.0393434, 0.0401578, 0.0409839, 
		0.0418219, 0.0426719, 0.0435338, 0.0444079, 0.0452941, 
		0.0461927, 0.0471036, 0.048027, 0.0489629, 0.0499115, 
		0.0508728, 0.051847, 0.052834, 0.053834, 0.0548471, 
		0.0558733, 0.0569128, 0.0579656, 0.0590318, 0.0601114, 
		0.0612047, 0.0623115, 0.0634321, 0.0645665, 0.0657148, 
		0.066877, 0.0680533, 0.0692437, 0.0704482, 0.071667, 
		0.0729002, 0.0741477, 0.0754097, 0.0766863, 0.0779775, 
		0.0792834, 0.080604, 0.0819394, 0.0832897, 0.084655, 
		0.0860353, 0.0874307, 0.0888412, 0.090267, 0.0917079, 
		0.0931643, 0.0946359, 0.0961231, 0.0976257, 0.0991439, 
		0.100678, 0.102227, 0.103792, 0.105373, 0.10697, 
		0.108582, 0.110211, 0.111855, 0.113516, 0.115192, 
		0.116885, 0.118593, 0.120318, 0.122059, 0.123816, 
		0.125589, 0.127379, 0.129185, 0.131008, 0.132846, 
		0.134702, 0.136573, 0.138461, 0.140366, 0.142287, 
		0.144225, 0.146179, 0.14815, 0.150137, 0.152141, 
		0.154161, 0.156199, 0.158252, 0.160323, 0.16241, 
		0.164514, 0.166634, 0.168771, 0.170924, 0.173095, 
		0.175282, 0.177485, 0.179705, 0.181942, 0.184195, 
		0.186465, 0.188752, 0.191055, 0.193375, 0.195711, 
		0.198064, 0.200433, 0.202819, 0.205221, 0.207639, 
		0.210074, 0.212525, 0.214992, 0.217476, 0.219976, 
		0.222492, 0.225025, 0.227573, 0.230137, 0.232718, 
		0.235314, 0.237926, 0.240554, 0.243198, 0.245858, 
		0.248533, 0.251224, 0.253931, 0.256653, 0.25939, 
		0.262143, 0.264911, 0.267694, 0.270493, 0.273306, 
		0.276135, 0.278978, 0.281836, 0.284709, 0.287596, 
		0.290498, 0.293415, 0.296346, 0.299291, 0.30225, 
		0.305223, 0.308211, 0.311212, 0.314227, 0.317256, 
		0.320298, 0.323353, 0.326422, 0.329505, 0.3326, 
		0.335708, 0.338829, 0.341963, 0.34511, 0.348268, 
		0.35144, 0.354623, 0.357819, 0.361026, 0.364246, 
		0.367477, 0.370719, 0.373973, 0.377239, 0.380515, 
		0.383802, 0.387101, 0.390409, 0.393729, 0.397058, 
		0.400398, 0.403748, 0.407108, 0.410478, 0.413857, 
		0.417245, 0.420643, 0.42405, 0.427465, 0.430889, 
		0.434322, 0.437764, 0.441213, 0.44467, 0.448135, 
		0.451608, 0.455089, 0.458576, 0.462071, 0.465572, 
		0.46908, 0.472595, 0.476116, 0.479643, 0.483176, 
		0.486715, 0.490259, 0.493809, 0.497363, 0.500923, 
		0.504487, 0.508056, 0.511629, 0.515206, 0.518787, 
		0.522371, 0.525959, 0.529551, 0.533145, 0.536742, 
		0.540341, 0.543943, 0.547547, 0.551153, 0.554761, 
		0.55837, 0.56198, 0.565591, 0.569203, 0.572816, 
		0.576428, 0.580041, 0.583654, 0.587266, 0.590878, 
		0.594489, 0.598098, 0.601707, 0.605313, 0.608918, 
		0.612521, 0.616122, 0.61972, 0.623315, 0.626907, 
		0.630496, 0.634082, 0.637663, 0.641241, 0.644814, 
		0.648383, 0.651947, 0.655507, 0.65906, 0.662609, 
		0.666152, 0.669688, 0.673219, 0.676743, 0.68026, 
		0.68377, 0.687273, 0.690769, 0.694256, 0.697736, 
		0.701208, 0.704671, 0.708125, 0.71157, 0.715006, 
		0.718433, 0.721849, 0.725256, 0.728653, 0.732038, 
		0.735414, 0.738778, 0.742131, 0.745472, 0.748802, 
		0.752119, 0.755425, 0.758718, 0.76998, 0.765265, 
		0.768519, 0.771759, 0.774985, 0.778198, 0.781396, 
		0.78458, 0.787749, 0.790903, 0.794042, 0.797165, 
		0.800272, 0.803364, 0.80644, 0.809499, 0.812541, 
		0.815566, 0.818574, 0.821565, 0.824538, 0.827494, 
		0.830431, 0.83335, 0.83625, 0.839132, 0.841994, 
		0.844837, 0.847661, 0.850465, 0.853249, 0.856013, 
		0.858757, 0.86148, 0.864182, 0.866863, 0.869523, 
		0.872161, 0.874778, 0.877373, 0.879945, 0.882496, 
		0.885023, 0.887528, 0.890011, 0.89247, 0.894905, 
		0.897317, 0.899706, 0.90207, 0.90441, 0.906726, 
		0.909017, 0.911284, 0.913526, 0.915743, 0.917934, 
		0.9201, 0.92224, 0.924355, 0.926443, 0.928506, 
		0.930542, 0.932551, 0.934534, 0.93649, 0.938419, 
		0.94032, 0.942195, 0.944042, 0.945861, 0.947653, 
		0.949416, 0.951152, 0.952859, 0.954538, 0.956188, 
		0.95781, 0.959402, 0.960966, 0.962501, 0.964007, 
		0.965483, 0.96693, 0.968347, 0.969734, 0.971092, 
		0.97242, 0.973717, 0.974985, 0.976222, 0.977429, 
		0.978605, 0.979751, 0.980866, 0.98195, 0.983004, 
		0.984026, 0.985018, 0.985978, 0.986907, 0.987805, 
		0.988671, 0.989506, 0.99031, 0.991081, 0.991822, 
		0.99253, 0.993207, 0.993852, 0.994464, 0.995045, 
		0.995594, 0.996111, 0.996596, 0.997049, 0.997469, 
		0.997858, 0.998214, 0.998538, 0.998829, 0.999088, 
		0.999315, 0.99951, 0.999672, 0.999801, 0.999899, 
		0.999964, 0.999996, 0.999996, 0.999964, 0.999899, 
		0.999801, 0.999672, 0.99951, 0.999315, 0.999088, 
		0.998829, 0.998538, 0.998214, 0.997858, 0.997469, 
		0.997049, 0.996596, 0.996111, 0.995594, 0.995045, 
		0.994464, 0.993852, 0.993207, 0.99253, 0.991822, 
		0.991081, 0.99031, 0.989506, 0.988671, 0.987805, 
		0.986907, 0.985978, 0.985018, 0.984026, 0.983004, 
		0.98195, 0.980866, 0.979751, 0.978605, 0.977429, 
		0.976222, 0.974985, 0.973717, 0.97242, 0.971092, 
		0.969734, 0.968347, 0.96693, 0.965483, 0.964007, 
		0.962501, 0.960966, 0.959402, 0.95781, 0.956188, 
		0.954538, 0.952859, 0.951152, 0.949416, 0.947653, 
		0.945861, 0.944042, 0.942195, 0.94032, 0.938419, 
		0.93649, 0.934534, 0.932551, 0.930542, 0.928506, 
		0.926443, 0.924355, 0.92224, 0.9201, 0.917934, 
		0.915743, 0.913526, 0.911284, 0.909017, 0.906726, 
		0.90441, 0.90207, 0.899706, 0.897317, 0.894905, 
		0.89247, 0.890011, 0.887528, 0.885023, 0.882496, 
		0.879945, 0.877373, 0.874778, 0.872161, 0.869523, 
		0.866863, 0.864182, 0.86148, 0.858757, 0.856013, 
		0.853249, 0.850465, 0.847661, 0.844837, 0.841994, 
		0.839132, 0.83625, 0.83335, 0.830431, 0.827494, 
		0.824538, 0.821565, 0.818574, 0.815566, 0.812541, 
		0.809499, 0.80644, 0.803364, 0.800272, 0.797165, 
		0.794042, 0.790903, 0.787749, 0.78458, 0.781396, 
		0.778198, 0.774985, 0.771759, 0.768519, 0.765265, 
		0.761998, 0.758718, 0.755425, 0.752119, 0.748802, 
		0.745472, 0.742131, 0.738778, 0.735414, 0.732038, 
		0.728653, 0.725256, 0.721849, 0.718433, 0.715006, 
		0.71157, 0.708125, 0.704671, 0.701208, 0.697736, 
		0.694256, 0.690769, 0.687273, 0.68377, 0.68026, 
		0.676743, 0.673219, 0.669688, 0.666152, 0.662609, 
		0.65906, 0.655507, 0.651947, 0.648383, 0.644814, 
		0.641241, 0.637663, 0.634082, 0.630496, 0.626907, 
		0.623315, 0.61972, 0.616122, 0.612521, 0.608918, 
		0.605313, 0.601707, 0.598098, 0.594489, 0.590878, 
		0.587266, 0.583654, 0.580041, 0.576428, 0.572816, 
		0.569203, 0.565591, 0.56198, 0.55837, 0.554761, 
		0.551153, 0.547547, 0.543943, 0.540341, 0.536742, 
		0.533145, 0.529551, 0.525959, 0.522371, 0.518787, 
		0.515206, 0.511629, 0.508056, 0.504487, 0.500923, 
		0.497363, 0.493809, 0.490259, 0.486715, 0.483176, 
		0.479643, 0.476116, 0.472595, 0.46908, 0.465572, 
		0.462071, 0.458576, 0.455089, 0.451608, 0.448135, 
		0.44467, 0.441213, 0.437764, 0.434322, 0.430889, 
		0.427465, 0.42405, 0.420643, 0.417245, 0.413857, 
		0.410478, 0.407108, 0.403748, 0.400398, 0.397058, 
		0.393729, 0.390409, 0.387101, 0.383802, 0.380515, 
		0.377239, 0.373973, 0.370719, 0.367477, 0.364246, 
		0.361026, 0.357819, 0.354623, 0.35144, 0.348268, 
		0.34511, 0.341963, 0.338829, 0.335708, 0.3326, 
		0.329505, 0.326422, 0.323353, 0.320298, 0.317256, 
		0.314227, 0.311212, 0.308211, 0.305223, 0.30225, 
		0.299291, 0.296346, 0.293415, 0.290498, 0.287596, 
		0.284709, 0.281836, 0.278978, 0.276135, 0.273306, 
		0.270493, 0.267694, 0.264911, 0.262143, 0.25939, 
		0.256653, 0.253931, 0.251224, 0.248533, 0.245858, 
		0.243198, 0.240554, 0.237926, 0.235314, 0.232718, 
		0.230137, 0.227573, 0.225025, 0.222492, 0.219976, 
		0.217476, 0.214992, 0.212525, 0.210074, 0.207639, 
		0.205221, 0.202819, 0.200433, 0.198064, 0.195711, 
		0.193375, 0.191055, 0.188752, 0.186465, 0.184195, 
		0.181942, 0.179705, 0.177485, 0.175282, 0.173095, 
		0.170924, 0.168771, 0.166634, 0.164514, 0.16241, 
		0.160323, 0.158252, 0.156199, 0.154161, 0.152141, 
		0.150137, 0.14815, 0.146179, 0.144225, 0.142287, 
		0.140366, 0.138461, 0.136573, 0.134702, 0.132846, 
		0.131008, 0.129185, 0.127379, 0.125589, 0.123816, 
		0.122059, 0.120318, 0.118593, 0.116885, 0.115192, 
		0.113516, 0.111855, 0.110211, 0.108582, 0.10697, 
		0.105373, 0.103792, 0.102227, 0.100678, 0.0991439, 
		0.0976257, 0.0961231, 0.0946359, 0.0931643, 0.0917079, 
		0.090267, 0.0888412, 0.0874307, 0.0860353, 0.084655, 
		0.0832897, 0.0819394, 0.080604, 0.0792834, 0.0779775, 
		0.0766863, 0.0754097, 0.0741477, 0.0729002, 0.071667, 
		0.0704482, 0.0692437, 0.0680533, 0.066877, 0.0657148, 
		0.0645665, 0.0634321, 0.0623115, 0.0612047, 0.0601114, 
		0.0590318, 0.0579656, 0.0569128, 0.0558733, 0.0548471, 
		0.053834, 0.052834, 0.051847, 0.0508728, 0.0499115, 
		0.0489629, 0.048027, 0.0471036, 0.0461927, 0.0452941, 
		0.0444079, 0.0435338, 0.0426719, 0.0418219, 0.0409839, 
		0.0401578, 0.0393434, 0.0385407, 0.0377495, 0.0369698, 
		0.0362015, 0.0354445, 0.0346987, 0.033964, 0.0332404, 
		0.0325276, 0.0318257, 0.0311345, 0.030454, 0.029784, 
		0.0291245, 0.0284753, 0.0278364, 0.0272077, 0.0265891, 
		0.0259804, 0.0253817, 0.0247927, 0.0242135, 0.0236438, 
		0.0230837, 0.022533, 0.0219916, 0.0214595, 0.0209364, 
		0.0204225, 0.0199175, 0.0194213, 0.0189339, 0.0184552, 
		0.0179851, 0.0175234, 0.0170702, 0.0166252, 0.0161885, 
		0.0157598, 0.0153392, 0.0149265, 0.0145217, 0.0141245, 
		0.0137351, 0.0133532, 0.0129788, 0.0126117, 0.012252, 
		0.0118995, 0.011554, 0.0112156, 0.0108841, 0.0105595, 
		0.0102416, 0.00993043, 0.00962581, 0.00932768, 0.00903597, 
		0.00875057, 0.00847141, 0.0081984, 0.00793146, 0.0076705, 
		0.00741544, 0.00716619, 0.00692266, 0.00668479, 0.00645248, 
		0.00622565, 0.00600423, 0.00578813, 0.00557726, 0.00537156, 
		0.00517094, 0.00497532, 0.00478463, 0.00459878, 0.0044177, 
		0.00424131, 0.00406954, 0.00390232, 0.00373955, 0.00358118, 
		0.00342713, 0.00327732, 0.00313168, 0.00299014, 0.00285263, 
		0.00271908, 0.00258941, 0.00246356, 0.00234145, 0.00222303, 
		0.00210821, 0.00199694, 0.00188915, 0.00178476, 0.00168373, 
		0.00158597, 0.00149143, 0.00140004, 0.00131174, 0.00122647, 
		0.00114416, 0.00106476, 0.000988196, 0.0009144211
	};

	// Windowing scale factor, found using Kaiser.m Matlab script
	float W0 = 421.1148;

	printf("Starting execution using %d samples per input block.\n",nsamp);

	arm_fill_f32(-1,ramp,blockSize);
	for(int i = 0; i<640; i++){
		ramp[i] = ((2*i)/640.)-1;
	}
	
	arm_fill_f32(-1,output,blockSize);
	while(1){
		/*
		 * Ask for a block of ADC samples to be put into the working buffer
		 *   getblock() will wait here until the input buffer is filled...  On return
		 *   we work on the new data buffer... then return here to wait for
		 *   the next block
		 */
		getblock(input);

		/*
		 * signal processing code to calculate the required output buffers
		 */

		DIGITAL_IO_SET();  // Use a scope on PD0 to measure execution time


		for(int n=0; n < blockSize; n++){
			real[n] = input[n] * cosine[(int)roundf(512*F_0/32000 * n)%512];
			cmplx[n] = input[n] * cosine[(int)roundf(512*F_0/32000 * n + 512/4)%512];
		}

		// Send input through FIR Decimation filter
		arm_fir_decimate_f32(s1, real, decBlock, blockSize);
		arm_copy_f32(decBlock,fft_real + counter*decimate_size, decimate_size);
		arm_fir_decimate_f32(s2, cmplx, decBlock, blockSize);
		arm_copy_f32(decBlock,fft_cmplx + counter*decimate_size, decimate_size);
		
		// Once 1024 decimated samples are collected then do FFT
		if(counter <= 7){
			counter++;
		}else{
			counter = 0;

			for(int i=0; i <= fftSize; i++){
				win_in[2*fftSize] = fft_real[i];
				win_in[2*fftSize+1] = fft_cmplx[i];
			}
			
			arm_cmplx_mult_real_f32(win_in, win, fft_array, fftSize);
			arm_cfft_f32(&arm_cfft_sR_f32_len1024, fft_array, 0, 1); // Calculate FFT
			arm_cmplx_mag_f32(fft_array, fft_real, fftSize);
			arm_scale_f32(fft_real, 1.0/100., fft_real, fftSize);
			arm_copy_f32(&fft_real[704],&output[0], 320);
			arm_copy_f32(&fft_real[0], &output[320], 320);
			
			for(int i = 0; i < 320; i++){
				temp = output[i];
				output[i] = output[639-i];
				output[639-i] = temp;
			}
		
			arm_offset_f32(output, -1, output, 640);


		}


		DIGITAL_IO_RESET();	// (falling edge....  done processing data )

		/*
		 * pass the processed working buffer back for DAC output
		 */
		putblockstereo(output, ramp);


		/* Set current frequency center, and display it (Takes care of question 3) */

		// Cycle through center frequency of mixer, f0, by pushing the button
		if (KeyPressed) {
			KeyPressed = RESET;
			button_count++;
			for(int i=0; i<fftSize/2;i++){
				printf("%f\n",fft_cmplx[i]);
			}
		}
		// If button presses exceeds the upper center limit, restart back to 0 
		if (button_count > 15) {
			button_count = 0;
		}

		// Multiply button count by 1000 to get KHz stepped frequency center
		F_0 = button_count*1000;


		// Display f_0
		sprintf(dispString,"%5d",F_0);

		// Clear the display
		BSP_LCD_GLASS_DisplayString(DISPLAY_CLEAR);

		// Display the center frequency
		BSP_LCD_GLASS_DisplayString((uint8_t *)dispString);


	}
	return 0;
}
