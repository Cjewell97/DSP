#include "stm32l4xx_hal.h"
#include "stm32l476g_discovery.h"
#include "ece486.h"
#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <stdint.h>
#include "arm_math.h"
#include "arm_const_structs.h"
#include <stdint.h>

// To detect a button press
extern FlagStatus KeyPressed;

#define DISPLAY_CLEAR	(uint8_t) "        "
#define SAMPLING_FREQUENCY	32000.00000
#define ONE_KHZ	1000.0


int main(void){
	float *input, *real, *cmplx;

	float *output;
	float *pState, *pState2;
	float *fft_real, *fft_cmplx, *fft_array, *decBlock, *win_in;

	uint32_t blockSize = 1280;
	setblocksize(blockSize);
	int numTaps = 75; // number of taps for FIR
	uint32_t fftSize = 1024; // Size of fft
	int M = 10; // Decimation factor
	int decimate_size = blockSize/M; //Number of samples after decimation

	int counter = 0;
	int temp;
	int button_count = 1;
	int F_0 = 1000; // Frequency being analyzed

static float cosine[512] = {
	1.000000, 0.999925, 0.999699, 0.999322, 0.998795, 0.998118, 0.997290, 0.996313,
	0.995185, 0.993907, 0.992480, 0.990903, 0.989177, 0.987301, 0.985278, 0.983105,
	0.980785, 0.978317, 0.975702, 0.972940, 0.970031, 0.966976, 0.963776, 0.960431,
	0.956940, 0.953306, 0.949528, 0.945607, 0.941544, 0.937339, 0.932993, 0.928506,
	0.923880, 0.919114, 0.914210, 0.909168, 0.903989, 0.898674, 0.893224, 0.887640,
	0.881921, 0.876070, 0.870087, 0.863973, 0.857729, 0.851355, 0.844854, 0.838225,
	0.831470, 0.824589, 0.817585, 0.810457, 0.803208, 0.795837, 0.788346, 0.780737,
	0.773010, 0.765167, 0.757209, 0.749136, 0.740951, 0.732654, 0.724247, 0.715731,
	0.707107, 0.698376, 0.689541, 0.680601, 0.671559, 0.662416, 0.653173, 0.643832,
	0.634393, 0.624859, 0.615232, 0.605511, 0.595699, 0.585798, 0.575808, 0.565732,
	0.555570, 0.545325, 0.534998, 0.524590, 0.514103, 0.503538, 0.492898, 0.482184,
	0.471397, 0.460539, 0.449611, 0.438616, 0.427555, 0.416430, 0.405241, 0.393992,
	0.382683, 0.371317, 0.359895, 0.348419, 0.336890, 0.325310, 0.313682, 0.302006,
	0.290285, 0.278520, 0.266713, 0.254866, 0.242980, 0.231058, 0.219101, 0.207111,
	0.195090, 0.183040, 0.170962, 0.158858, 0.146730, 0.134581, 0.122411, 0.110222,
	0.098017, 0.085797, 0.073565, 0.061321, 0.049068, 0.036807, 0.024541, 0.012272,
	0.000000, -0.012272, -0.024541, -0.036807, -0.049068, -0.061321, -0.073565, -0.085797,
	-0.098017, -0.110222, -0.122411, -0.134581, -0.146730, -0.158858, -0.170962, -0.183040,
	-0.195090, -0.207111, -0.219101, -0.231058, -0.242980, -0.254866, -0.266713, -0.278520,
	-0.290285, -0.302006, -0.313682, -0.325310, -0.336890, -0.348419, -0.359895, -0.371317,
	-0.382683, -0.393992, -0.405241, -0.416430, -0.427555, -0.438616, -0.449611, -0.460539,
	-0.471397, -0.482184, -0.492898, -0.503538, -0.514103, -0.524590, -0.534998, -0.545325,
	-0.555570, -0.565732, -0.575808, -0.585798, -0.595699, -0.605511, -0.615232, -0.624859,
	-0.634393, -0.643832, -0.653173, -0.662416, -0.671559, -0.680601, -0.689541, -0.698376,
	-0.707107, -0.715731, -0.724247, -0.732654, -0.740951, -0.749136, -0.757209, -0.765167,
	-0.773010, -0.780737, -0.788346, -0.795837, -0.803208, -0.810457, -0.817585, -0.824589,
	-0.831470, -0.838225, -0.844854, -0.851355, -0.857729, -0.863973, -0.870087, -0.876070,
	-0.881921, -0.887640, -0.893224, -0.898674, -0.903989, -0.909168, -0.914210, -0.919114,
	-0.923880, -0.928506, -0.932993, -0.937339, -0.941544, -0.945607, -0.949528, -0.953306,
	-0.956940, -0.960431, -0.963776, -0.966976, -0.970031, -0.972940, -0.975702, -0.978317,
	-0.980785, -0.983105, -0.985278, -0.987301, -0.989177, -0.990903, -0.992480, -0.993907,
	-0.995185, -0.996313, -0.997290, -0.998118, -0.998795, -0.999322, -0.999699, -0.999925,
	-1.000000, -0.999925, -0.999699, -0.999322, -0.998795, -0.998118, -0.997290, -0.996313,
	-0.995185, -0.993907, -0.992480, -0.990903, -0.989177, -0.987301, -0.985278, -0.983105,
	-0.980785, -0.978317, -0.975702, -0.972940, -0.970031, -0.966976, -0.963776, -0.960431,
	-0.956940, -0.953306, -0.949528, -0.945607, -0.941544, -0.937339, -0.932993, -0.928506,
	-0.923880, -0.919114, -0.914210, -0.909168, -0.903989, -0.898674, -0.893224, -0.887640,
	-0.881921, -0.876070, -0.870087, -0.863973, -0.857729, -0.851355, -0.844854, -0.838225,
	-0.831470, -0.824589, -0.817585, -0.810457, -0.803208, -0.795837, -0.788346, -0.780737,
	-0.773010, -0.765167, -0.757209, -0.749136, -0.740951, -0.732654, -0.724247, -0.715731,
	-0.707107, -0.698376, -0.689541, -0.680601, -0.671559, -0.662416, -0.653173, -0.643832,
	-0.634393, -0.624859, -0.615232, -0.605511, -0.595699, -0.585798, -0.575808, -0.565732,
	-0.555570, -0.545325, -0.534998, -0.524590, -0.514103, -0.503538, -0.492898, -0.482184,
	-0.471397, -0.460539, -0.449611, -0.438616, -0.427555, -0.416430, -0.405241, -0.393992,
	-0.382683, -0.371317, -0.359895, -0.348419, -0.336890, -0.325310, -0.313682, -0.302006,
	-0.290285, -0.278520, -0.266713, -0.254866, -0.242980, -0.231058, -0.219101, -0.207111,
	-0.195090, -0.183040, -0.170962, -0.158858, -0.146730, -0.134581, -0.122411, -0.110222,
	-0.098017, -0.085797, -0.073565, -0.061321, -0.049068, -0.036807, -0.024541, -0.012272,
	-0.000000, 0.012272, 0.024541, 0.036807, 0.049068, 0.061321, 0.073565, 0.085797,
	0.098017, 0.110222, 0.122411, 0.134581, 0.146730, 0.158858, 0.170962, 0.183040,
	0.195090, 0.207111, 0.219101, 0.231058, 0.242980, 0.254866, 0.266713, 0.278520,
	0.290285, 0.302006, 0.313682, 0.325310, 0.336890, 0.348419, 0.359895, 0.371317,
	0.382683, 0.393992, 0.405241, 0.416430, 0.427555, 0.438616, 0.449611, 0.460539,
	0.471397, 0.482184, 0.492898, 0.503538, 0.514103, 0.524590, 0.534998, 0.545325,
	0.555570, 0.565732, 0.575808, 0.585798, 0.595699, 0.605511, 0.615232, 0.624859,
	0.634393, 0.643832, 0.653173, 0.662416, 0.671559, 0.680601, 0.689541, 0.698376,
	0.707107, 0.715731, 0.724247, 0.732654, 0.740951, 0.749136, 0.757209, 0.765167,
	0.773010, 0.780737, 0.788346, 0.795837, 0.803208, 0.810457, 0.817585, 0.824589,
	0.831470, 0.838225, 0.844854, 0.851355, 0.857729, 0.863973, 0.870087, 0.876070,
	0.881921, 0.887640, 0.893224, 0.898674, 0.903989, 0.909168, 0.914210, 0.919114,
	0.923880, 0.928506, 0.932993, 0.937339, 0.941544, 0.945607, 0.949528, 0.953306,
	0.956940, 0.960431, 0.963776, 0.966976, 0.970031, 0.972940, 0.975702, 0.978317,
	0.980785, 0.983105, 0.985278, 0.987301, 0.989177, 0.990903, 0.992480, 0.993907,
	0.995185, 0.996313, 0.997290, 0.998118, 0.998795, 0.999322, 0.999699, 0.999925,
};

//Filter coefficients. The transition region is 1k to 2.2k
	static float pCoeffs[75]=	{	
	 0.00113455273471314540059691305578232,
	 0.001699237856734259199953385177650488913,
	 0.002372978856351966748389203942792846647,
	 0.0030661922227558724776685927793096198  ,
	 0.003686205203789461558316897793474709033,
	 0.004124633099526988158634033254656969802,
	 0.004265876592450362249364648192795357318,
	 0.003998555345094188459564854554173507495,
	 0.003231466554200309020811188176480754919,
	 0.001910217012675314435243834054745093454,
	 0.000032786164465227604289387919322962262,
	-0.002337135187243520768884952332200555247,
	-0.005062655502679251628972423304730909877,
	-0.007932763752316385197360659731202758849,
	-0.010669436472747498290125633957359241322,
	-0.012942984873164087300523306112154386938,
	-0.014395019943036248266654553162879892625,
	-0.014667957349316539800154757244854408782,
	-0.013438641602154667575863555839532637037,
	-0.010452954981632834458027403456981119234,
	-0.00555761860895989841246933593765788828 ,
	 0.001273869895185063402451297598361179553,
	 0.009924714577150151734175054230036039371,
	 0.020129388351999517869916900281168636866,
	 0.031481127923038428051416559583230991848,
	 0.043453339202320959144820733399683376774,
	 0.055432088874347598683733906455017859116,
	 0.066759492909291090478873798019776586443,
	 0.076781469011989830764086661929468391463,
	 0.084896600900275273615669391347182681784,
	 0.090607565952797175512500871263910084963,
	 0.093555370936809600923567131758318282664,
	 0.093555370936809600923567131758318282664,
	 0.090607565952797175512500871263910084963,
	 0.084896600900275273615669391347182681784,
	 0.076781469011989830764086661929468391463,
	 0.066759492909291090478873798019776586443,
	 0.055432088874347598683733906455017859116,
	 0.043453339202320959144820733399683376774,
	 0.031481127923038428051416559583230991848,
	 0.020129388351999517869916900281168636866,
	 0.009924714577150151734175054230036039371,
	 0.001273869895185063402451297598361179553,
	-0.00555761860895989841246933593765788828 ,
	-0.010452954981632834458027403456981119234,
	-0.013438641602154667575863555839532637037,
	-0.014667957349316539800154757244854408782,
	-0.014395019943036248266654553162879892625,
	-0.012942984873164087300523306112154386938,
	-0.010669436472747498290125633957359241322,
	-0.007932763752316385197360659731202758849,
	-0.005062655502679251628972423304730909877,
	-0.002337135187243520768884952332200555247,
	 0.000032786164465227604289387919322962262,
	 0.001910217012675314435243834054745093454,
	 0.003231466554200309020811188176480754919,
	 0.003998555345094188459564854554173507495,
	 0.004265876592450362249364648192795357318,
	 0.004124633099526988158634033254656969802,
	 0.003686205203789461558316897793474709033,
	 0.0030661922227558724776685927793096198  ,
	 0.002372978856351966748389203942792846647,
	 0.001699237856734259199953385177650488913,
	 0.001134552734713145400596845391305578232,
	 0.000859272050356308433188834428051450232,
	};


//kaiser window (9)
float win[1024] = {0.000914, 0.000988, 0.001065, 0.001144, 0.001226, 0.001312, 0.001400, 0.001491, 0.001586, 0.001684,
0.001785, 0.001889, 0.001997, 0.002108, 0.002223, 0.002341, 0.002464, 0.002589, 0.002719, 0.002853,
0.002990, 0.003132, 0.003277, 0.003427, 0.003581, 0.003740, 0.003902, 0.004070, 0.004241, 0.004418,
0.004599, 0.004785, 0.004975, 0.005171, 0.005372, 0.005577, 0.005788, 0.006004, 0.006226, 0.006452,
0.006685, 0.006923, 0.007166, 0.007415, 0.007671, 0.007931, 0.008198, 0.008471, 0.008751, 0.009036,
0.009328, 0.009626, 0.009930, 0.010242, 0.010560, 0.010884, 0.011216, 0.011554, 0.011899, 0.012252,
0.012612, 0.012979, 0.013353, 0.013735, 0.014125, 0.014522, 0.014927, 0.015339, 0.015760, 0.016188,
0.016625, 0.017070, 0.017523, 0.017985, 0.018455, 0.018934, 0.019421, 0.019917, 0.020422, 0.020936,
0.021459, 0.021992, 0.022533, 0.023084, 0.023644, 0.024213, 0.024793, 0.025382, 0.025980, 0.026589,
0.027208, 0.027836, 0.028475, 0.029124, 0.029784, 0.030454, 0.031135, 0.031826, 0.032528, 0.033240,
0.033964, 0.034699, 0.035445, 0.036202, 0.036970, 0.037750, 0.038541, 0.039343, 0.040158, 0.040984,
0.041822, 0.042672, 0.043534, 0.044408, 0.045294, 0.046193, 0.047104, 0.048027, 0.048963, 0.049912,
0.050873, 0.051847, 0.052834, 0.053834, 0.054847, 0.055873, 0.056913, 0.057966, 0.059032, 0.060111,
0.061205, 0.062312, 0.063432, 0.064567, 0.065715, 0.066877, 0.068053, 0.069244, 0.070448, 0.071667,
0.072900, 0.074148, 0.075410, 0.076686, 0.077977, 0.079283, 0.080604, 0.081939, 0.083290, 0.084655,
0.086035, 0.087431, 0.088841, 0.090267, 0.091708, 0.093164, 0.094636, 0.096123, 0.097626, 0.099144,
0.100678, 0.102227, 0.103792, 0.105373, 0.106970, 0.108582, 0.110211, 0.111855, 0.113516, 0.115192,
0.116885, 0.118593, 0.120318, 0.122059, 0.123816, 0.125589, 0.127379, 0.129185, 0.131008, 0.132846,
0.134702, 0.136573, 0.138461, 0.140366, 0.142287, 0.144225, 0.146179, 0.148150, 0.150137, 0.152141,
0.154161, 0.156199, 0.158252, 0.160323, 0.162410, 0.164514, 0.166634, 0.168771, 0.170924, 0.173095,
0.175282, 0.177485, 0.179705, 0.181942, 0.184195, 0.186465, 0.188752, 0.191055, 0.193375, 0.195711,
0.198064, 0.200433, 0.202819, 0.205221, 0.207639, 0.210074, 0.212525, 0.214992, 0.217476, 0.219976,
0.222492, 0.225025, 0.227573, 0.230137, 0.232718, 0.235314, 0.237926, 0.240554, 0.243198, 0.245858,
0.248533, 0.251224, 0.253931, 0.256653, 0.259390, 0.262143, 0.264911, 0.267694, 0.270493, 0.273306,
0.276135, 0.278978, 0.281836, 0.284709, 0.287596, 0.290498, 0.293415, 0.296346, 0.299291, 0.302250,
0.305223, 0.308211, 0.311212, 0.314227, 0.317256, 0.320298, 0.323353, 0.326422, 0.329505, 0.332600,
0.335708, 0.338829, 0.341963, 0.345110, 0.348268, 0.351440, 0.354623, 0.357819, 0.361026, 0.364246,
0.367477, 0.370719, 0.373973, 0.377239, 0.380515, 0.383802, 0.387101, 0.390409, 0.393729, 0.397058,
0.400398, 0.403748, 0.407108, 0.410478, 0.413857, 0.417245, 0.420643, 0.424050, 0.427465, 0.430889,
0.434322, 0.437764, 0.441213, 0.444670, 0.448135, 0.451608, 0.455089, 0.458576, 0.462071, 0.465572,
0.469080, 0.472595, 0.476116, 0.479643, 0.483176, 0.486715, 0.490259, 0.493809, 0.497363, 0.500923,
0.504487, 0.508056, 0.511629, 0.515206, 0.518787, 0.522371, 0.525959, 0.529551, 0.533145, 0.536742,
0.540341, 0.543943, 0.547547, 0.551153, 0.554761, 0.558370, 0.561980, 0.565591, 0.569203, 0.572816,
0.576428, 0.580041, 0.583654, 0.587266, 0.590878, 0.594489, 0.598098, 0.601707, 0.605313, 0.608918,
0.612521, 0.616122, 0.619720, 0.623315, 0.626907, 0.630496, 0.634082, 0.637663, 0.641241, 0.644814,
0.648383, 0.651947, 0.655507, 0.659060, 0.662609, 0.666152, 0.669688, 0.673219, 0.676743, 0.680260,
0.683770, 0.687273, 0.690769, 0.694256, 0.697736, 0.701208, 0.704671, 0.708125, 0.711570, 0.715006,
0.718433, 0.721849, 0.725256, 0.728653, 0.732038, 0.735414, 0.738778, 0.742131, 0.745472, 0.748802,
0.752119, 0.755425, 0.758718, 0.761998, 0.765265, 0.768519, 0.771759, 0.774985, 0.778198, 0.781396,
0.784580, 0.787749, 0.790903, 0.794042, 0.797165, 0.800272, 0.803364, 0.806440, 0.809499, 0.812541,
0.815566, 0.818574, 0.821565, 0.824538, 0.827494, 0.830431, 0.833350, 0.836250, 0.839132, 0.841994,
0.844837, 0.847661, 0.850465, 0.853249, 0.856013, 0.858757, 0.861480, 0.864182, 0.866863, 0.869523,
0.872161, 0.874778, 0.877373, 0.879945, 0.882496, 0.885023, 0.887528, 0.890011, 0.892470, 0.894905,
0.897317, 0.899706, 0.902070, 0.904410, 0.906726, 0.909017, 0.911284, 0.913526, 0.915743, 0.917934,
0.920100, 0.922240, 0.924355, 0.926443, 0.928506, 0.930542, 0.932551, 0.934534, 0.936490, 0.938419,
0.940320, 0.942195, 0.944042, 0.945861, 0.947653, 0.949416, 0.951152, 0.952859, 0.954538, 0.956188,
0.957810, 0.959402, 0.960966, 0.962501, 0.964007, 0.965483, 0.966930, 0.968347, 0.969734, 0.971092,
0.972420, 0.973717, 0.974985, 0.976222, 0.977429, 0.978605, 0.979751, 0.980866, 0.981950, 0.983004,
0.984026, 0.985018, 0.985978, 0.986907, 0.987805, 0.988671, 0.989506, 0.990310, 0.991081, 0.991822,
0.992530, 0.993207, 0.993852, 0.994464, 0.995045, 0.995594, 0.996111, 0.996596, 0.997049, 0.997469,
0.997858, 0.998214, 0.998538, 0.998829, 0.999088, 0.999315, 0.999510, 0.999672, 0.999801, 0.999899,
0.999964, 0.999996, 0.999996, 0.999964, 0.999899, 0.999801, 0.999672, 0.999510, 0.999315, 0.999088,
0.998829, 0.998538, 0.998214, 0.997858, 0.997469, 0.997049, 0.996596, 0.996111, 0.995594, 0.995045,
0.994464, 0.993852, 0.993207, 0.992530, 0.991822, 0.991081, 0.990310, 0.989506, 0.988671, 0.987805,
0.986907, 0.985978, 0.985018, 0.984026, 0.983004, 0.981950, 0.980866, 0.979751, 0.978605, 0.977429,
0.976222, 0.974985, 0.973717, 0.972420, 0.971092, 0.969734, 0.968347, 0.966930, 0.965483, 0.964007,
0.962501, 0.960966, 0.959402, 0.957810, 0.956188, 0.954538, 0.952859, 0.951152, 0.949416, 0.947653,
0.945861, 0.944042, 0.942195, 0.940320, 0.938419, 0.936490, 0.934534, 0.932551, 0.930542, 0.928506,
0.926443, 0.924355, 0.922240, 0.920100, 0.917934, 0.915743, 0.913526, 0.911284, 0.909017, 0.906726,
0.904410, 0.902070, 0.899706, 0.897317, 0.894905, 0.892470, 0.890011, 0.887528, 0.885023, 0.882496,
0.879945, 0.877373, 0.874778, 0.872161, 0.869523, 0.866863, 0.864182, 0.861480, 0.858757, 0.856013,
0.853249, 0.850465, 0.847661, 0.844837, 0.841994, 0.839132, 0.836250, 0.833350, 0.830431, 0.827494,
0.824538, 0.821565, 0.818574, 0.815566, 0.812541, 0.809499, 0.806440, 0.803364, 0.800272, 0.797165,
0.794042, 0.790903, 0.787749, 0.784580, 0.781396, 0.778198, 0.774985, 0.771759, 0.768519, 0.765265,
0.761998, 0.758718, 0.755425, 0.752119, 0.748802, 0.745472, 0.742131, 0.738778, 0.735414, 0.732038,
0.728653, 0.725256, 0.721849, 0.718433, 0.715006, 0.711570, 0.708125, 0.704671, 0.701208, 0.697736,
0.694256, 0.690769, 0.687273, 0.683770, 0.680260, 0.676743, 0.673219, 0.669688, 0.666152, 0.662609,
0.659060, 0.655507, 0.651947, 0.648383, 0.644814, 0.641241, 0.637663, 0.634082, 0.630496, 0.626907,
0.623315, 0.619720, 0.616122, 0.612521, 0.608918, 0.605313, 0.601707, 0.598098, 0.594489, 0.590878,
0.587266, 0.583654, 0.580041, 0.576428, 0.572816, 0.569203, 0.565591, 0.561980, 0.558370, 0.554761,
0.551153, 0.547547, 0.543943, 0.540341, 0.536742, 0.533145, 0.529551, 0.525959, 0.522371, 0.518787,
0.515206, 0.511629, 0.508056, 0.504487, 0.500923, 0.497363, 0.493809, 0.490259, 0.486715, 0.483176,
0.479643, 0.476116, 0.472595, 0.469080, 0.465572, 0.462071, 0.458576, 0.455089, 0.451608, 0.448135,
0.444670, 0.441213, 0.437764, 0.434322, 0.430889, 0.427465, 0.424050, 0.420643, 0.417245, 0.413857,
0.410478, 0.407108, 0.403748, 0.400398, 0.397058, 0.393729, 0.390409, 0.387101, 0.383802, 0.380515,
0.377239, 0.373973, 0.370719, 0.367477, 0.364246, 0.361026, 0.357819, 0.354623, 0.351440, 0.348268,
0.345110, 0.341963, 0.338829, 0.335708, 0.332600, 0.329505, 0.326422, 0.323353, 0.320298, 0.317256,
0.314227, 0.311212, 0.308211, 0.305223, 0.302250, 0.299291, 0.296346, 0.293415, 0.290498, 0.287596,
0.284709, 0.281836, 0.278978, 0.276135, 0.273306, 0.270493, 0.267694, 0.264911, 0.262143, 0.259390,
0.256653, 0.253931, 0.251224, 0.248533, 0.245858, 0.243198, 0.240554, 0.237926, 0.235314, 0.232718,
0.230137, 0.227573, 0.225025, 0.222492, 0.219976, 0.217476, 0.214992, 0.212525, 0.210074, 0.207639,
0.205221, 0.202819, 0.200433, 0.198064, 0.195711, 0.193375, 0.191055, 0.188752, 0.186465, 0.184195,
0.181942, 0.179705, 0.177485, 0.175282, 0.173095, 0.170924, 0.168771, 0.166634, 0.164514, 0.162410,
0.160323, 0.158252, 0.156199, 0.154161, 0.152141, 0.150137, 0.148150, 0.146179, 0.144225, 0.142287,
0.140366, 0.138461, 0.136573, 0.134702, 0.132846, 0.131008, 0.129185, 0.127379, 0.125589, 0.123816,
0.122059, 0.120318, 0.118593, 0.116885, 0.115192, 0.113516, 0.111855, 0.110211, 0.108582, 0.106970,
0.105373, 0.103792, 0.102227, 0.100678, 0.099144, 0.097626, 0.096123, 0.094636, 0.093164, 0.091708,
0.090267, 0.088841, 0.087431, 0.086035, 0.084655, 0.083290, 0.081939, 0.080604, 0.079283, 0.077977,
0.076686, 0.075410, 0.074148, 0.072900, 0.071667, 0.070448, 0.069244, 0.068053, 0.066877, 0.065715,
0.064567, 0.063432, 0.062312, 0.061205, 0.060111, 0.059032, 0.057966, 0.056913, 0.055873, 0.054847,
0.053834, 0.052834, 0.051847, 0.050873, 0.049912, 0.048963, 0.048027, 0.047104, 0.046193, 0.045294,
0.044408, 0.043534, 0.042672, 0.041822, 0.040984, 0.040158, 0.039343, 0.038541, 0.037750, 0.036970,
0.036202, 0.035445, 0.034699, 0.033964, 0.033240, 0.032528, 0.031826, 0.031135, 0.030454, 0.029784,
0.029124, 0.028475, 0.027836, 0.027208, 0.026589, 0.025980, 0.025382, 0.024793, 0.024213, 0.023644,
0.023084, 0.022533, 0.021992, 0.021459, 0.020936, 0.020422, 0.019917, 0.019421, 0.018934, 0.018455,
0.017985, 0.017523, 0.017070, 0.016625, 0.016188, 0.015760, 0.015339, 0.014927, 0.014522, 0.014125,
0.013735, 0.013353, 0.012979, 0.012612, 0.012252, 0.011899, 0.011554, 0.011216, 0.010884, 0.010560,
0.010242, 0.009930, 0.009626, 0.009328, 0.009036, 0.008751, 0.008471, 0.008198, 0.007931, 0.007671,
0.007415, 0.007166, 0.006923, 0.006685, 0.006452, 0.006226, 0.006004, 0.005788, 0.005577, 0.005372,
0.005171, 0.004975, 0.004785, 0.004599, 0.004418, 0.004241, 0.004070, 0.003902, 0.003740, 0.003581,
0.003427, 0.003277, 0.003132, 0.002990, 0.002853, 0.002719, 0.002589, 0.002464, 0.002341, 0.002223,
0.002108, 0.001997, 0.001889, 0.001785, 0.001684, 0.001586, 0.001491, 0.001400, 0.001312, 0.001226,
0.001144, 0.001065, 0.000988, 0.000914};

	char dispString[8] = "Freq";
	// Initialize the board
	initialize_ece486(FS_32K, MONO_IN, STEREO_OUT, HSE_EXTERNAL_8MHz);

	//create instance of the decimate filter
	arm_fir_decimate_instance_f32 *s1 = (arm_fir_decimate_instance_f32 *)malloc(sizeof(arm_fir_decimate_instance_f32));
	arm_fir_decimate_instance_f32 *s2 = (arm_fir_decimate_instance_f32 *)malloc(sizeof(arm_fir_decimate_instance_f32));

	//h = (float32_t *)malloc(m*sizeof(float32_t));
	pState = (float32_t *)malloc((numTaps+blockSize-1)*sizeof(float32_t));
	pState2 = (float32_t *)malloc((numTaps+blockSize-1)*sizeof(float32_t));


	//initialization of decimate filter
	arm_fir_decimate_init_f32(s1, numTaps, M, pCoeffs, pState, blockSize);
	arm_fir_decimate_init_f32(s2, numTaps, M, pCoeffs, pState2, blockSize);

	//places to store the real and complex signals after mixing
	real = (float *)calloc(blockSize,sizeof(float));
	cmplx = (float *)calloc(blockSize,sizeof(float));

	//buffer to store the decimate values
	decBlock = (float *)calloc(decimate_size,sizeof(float));
	//Array for all the decimated values for both the complex and real signals
	fft_real = (float *)calloc(fftSize,sizeof(float));
	fft_cmplx = (float *)calloc(fftSize,sizeof(float));

	//Array for the interleaved real and complex signals
	fft_array = (float *)calloc(fftSize*2,sizeof(float));
	win_in = (float *)calloc(fftSize*2,sizeof(float));
	//Input block
	output = (float *)calloc(blockSize,sizeof(float));
	input = (float *)calloc(blockSize,sizeof(float));



	if (real==NULL || cmplx==NULL || output==NULL || input==NULL || pState2 == NULL || pState == NULL || fft_real == NULL || fft_cmplx == NULL || fft_array == NULL || decBlock == NULL || win_in == NULL) {
		flagerror(MEMORY_ALLOCATION_ERROR);
		while(1);
	}

	printf("Starting execution using %d samples per input block.\n",getblocksize());

	float ramp[1280];
	arm_fill_f32(-1,ramp,blockSize);
	for(int i = 0; i<640; i++){
		ramp[i] = ((2*i)/640.)-1;
	}
	
	arm_fill_f32(-1,output,blockSize);
	while(1){
		/*
		 * Ask for a block of ADC samples to be put into the working buffer
		 *   getblock() will wait here until the input buffer is filled...  On return
		 *   we work on the new data buffer... then return here to wait for
		 *   the next block
		 */
		getblock(input);

		/*
		 * signal processing code to calculate the required output buffers
		 */

		DIGITAL_IO_SET();  // Use a scope on PD0 to measure execution time


		for(int n=0; n < blockSize; n++){
			real[n] = input[n] * cosine[(int)roundf(512*F_0/32000 * n)%512];
			cmplx[n] = input[n] * cosine[(int)roundf(512*F_0/32000 * n + 512/4)%512];
		}

		// Send input through FIR Decimation filter
		arm_fir_decimate_f32(s1, real, decBlock, blockSize);
		arm_copy_f32(decBlock,fft_real + counter*decimate_size, decimate_size);
		arm_fir_decimate_f32(s2, cmplx, decBlock, blockSize);
		arm_copy_f32(decBlock,fft_cmplx + counter*decimate_size, decimate_size);
		
		// Once 1024 decimated samples are collected then do FFT
		if(counter <= 7){
			counter++;
		}else{
			counter = 0;

			for(int i = 0; i<2*fftSize;i++){
				if(i%2 == 0){
					win_in[i] = fft_real[(int)(i*.5)];
				}else{
					win_in[i] = fft_cmplx[(int)((i-1)*.5)];
				}

			}
//			for(int i=0; i < fftSize; i++){
//				win_in[2*fftSize] = fft_real[i];
//				win_in[2*fftSize+1] = fft_cmplx[i];
//			}
			
			arm_cmplx_mult_real_f32(win_in, win, fft_array, fftSize);
			arm_cfft_f32(&arm_cfft_sR_f32_len1024, fft_array, 0, 1); // Calculate FFT
			arm_cmplx_mag_f32(fft_array, fft_real, fftSize);
			arm_scale_f32(fft_real, 1.0/42, fft_real, fftSize);
			arm_copy_f32(&fft_real[704],&output[0], 320);
			arm_copy_f32(&fft_real[0], &output[320], 320);
			
			for(int i = 0; i < 320; i++){
				temp = output[i];
				output[i] = output[639-i];
				output[639-i] = temp;
			}
		
			arm_offset_f32(output, -1, output, 640);


		}


		DIGITAL_IO_RESET();	// (falling edge....  done processing data )

		/*
		 * pass the processed working buffer back for DAC output
		 */
		putblockstereo(output, ramp);


		/* Set current frequency center, and display it (Takes care of question 3) */

		// Cycle through center frequency of mixer, f0, by pushing the button
		if (KeyPressed) {
			KeyPressed = RESET;
			button_count++;
			if (button_count > 15) {
				button_count = 1;
			}
			F_0 = button_count*1000;
			printf("%d\n",F_0);
//			for(int i=0; i<fftSize/2;i++){
//				printf("%f\n",fft_cmplx[i]);
//			}
		}
		// If button presses exceeds the upper center limit, restart back to 0 

		// Multiply button count by 1000 to get KHz stepped frequency center


		// Display f_0
		sprintf(dispString,"%5d",F_0);

		// Display the center frequency
		BSP_LCD_GLASS_DisplayString((uint8_t *)dispString);


	}
	return 0;
}
